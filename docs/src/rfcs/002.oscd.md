# RFC: Continuous OS Deployment

***PENDING***

## Summary

Operating System Continuous Deployment (OSCD) refers to the process of seamlessly upgrading my NixOS machines to the latest and greatest release with as little overhead and manual fiddling as possible. This RFC proposes an OSCD overhaul that achieves a greater level of automation and reproducibility in the OS upgrade process via a few added GitHub CD hooks, the new CLI tool [anix-upgrade](../misc/anix-upgrade.md), and some development process changes.

## Motivation

NixOS upgrades on my machines are done using the [nixos-rebuild](https://nixos.wiki/wiki/Nixos-rebuild) command, which builds the system configuration according to the (symlinked) file `/etc/nixos/configuration.nix`, which points to a mutable root configuration file in `~/sources/anixpkgs/`.

This model lends itself best to rapid prototyping and test, as changes to the configuration can be immediately tested without having to commit any code. However, release deployment strategies are left to be more ad hoc and manual (and thus error-prone) under this model, as well. For example, to tag and deploy a new release off of master, the following manual steps must be taken:

1. The desired release commit is tagged, either locally or via the GitHub releases page.
2. The `dependencies.nix` file for all NixOS configurations is modified to refer to the new tag, manifesting as a new commit on the head of master.
3. `~/sources/anixpkgs/` is checked out to the commit from step 2 (*not* step 1, ironically). Any local dev changes need to be stashed.
4. A `nixos-rebuild` command is run.

This RFC calls for a mature, stable OSCD pipeline that removes the need for the manual steps listed above while maintaining flexibility for rapid (and decoupled) on-machine development and testing.

## Driving requirements

### System-level requirements

- **[SR1]** OSCD shall be totally decoupled from development work; there shall be no possibility of one accidentally polluting the other.
- **[SR2]** OSCD shall be atomic such that an upgrade cannot be corrupted via a mismanagement or erroneous execution of steps.
- **[SR3]** OS release tagging shall be wholly executable within an `anixpkgs` pull request, and shall be entirely automated except for a manual specification of the level of release (e.g., major, minor, patch) that the pull request corresponds to.
- **[SR4]** An OS upgrade on-machine shall take no more than one step to complete.
- **[SR5]** The same upgrade mechanism from **[SR4]** shall enable rapid prototyping of active development branches.

### Software-level requirements

- **[R1]** ...


## Detailed design

This is the bulk of the RFC. Explain the design in enough detail for somebody familiar with the network to understand, and for somebody familiar with the code practices to implement. This should get into specifics and corner-cases, and include examples of how the feature is used.

## Drawbacks

Why should we not do this?

## Alternatives

What other designs have been considered? What is the impact of not doing this?

## Unresolved questions

What parts of the design are still to be done?
